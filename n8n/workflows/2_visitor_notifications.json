{
  "name": "ðŸ“§ Visitor Notifications & Alerts",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 15
            }
          ]
        }
      },
      "id": "schedule-check",
      "name": "Schedule: Every 15 min",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  id, landing_mode, referrer_source, contact_submitted, cv_downloaded,\n  created_at, page_views, projects_viewed\nFROM visitor_sessions\nWHERE created_at > NOW() - INTERVAL '15 minutes'\nORDER BY created_at DESC;"
      },
      "id": "get-new-sessions",
      "name": "PostgreSQL: Get New Sessions",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [450, 300],
      "credentials": {
        "postgres": {
          "id": "2",
          "name": "Portfolio PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json.length }}",
              "operation": "larger",
              "value2": 0
            }
          ]
        }
      },
      "id": "check-has-visitors",
      "name": "IF: Has New Visitors?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [650, 300]
    },
    {
      "parameters": {
        "jsCode": "// Aggregate visitor stats\nconst sessions = $input.all();\n\nconst stats = {\n  total_visitors: sessions.length,\n  cdi_mode: sessions.filter(s => s.json.landing_mode === 'cdi').length,\n  freelance_mode: sessions.filter(s => s.json.landing_mode === 'freelance').length,\n  contacts: sessions.filter(s => s.json.contact_submitted).length,\n  cv_downloads: sessions.filter(s => s.json.cv_downloaded).length,\n  avg_page_views: (sessions.reduce((sum, s) => sum + s.json.page_views, 0) / sessions.length).toFixed(1),\n  referrers: {\n    google: sessions.filter(s => s.json.referrer_source === 'google').length,\n    linkedin: sessions.filter(s => s.json.referrer_source === 'linkedin').length,\n    direct: sessions.filter(s => s.json.referrer_source === 'direct').length,\n    other: sessions.filter(s => !['google', 'linkedin', 'direct'].includes(s.json.referrer_source)).length\n  },\n  high_engagement: sessions.filter(s => s.json.page_views >= 5 || s.json.projects_viewed >= 3).length\n};\n\nreturn [{ json: stats }];"
      },
      "id": "aggregate-stats",
      "name": "Code: Aggregate Stats",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [850, 200]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  cs.name, cs.email, cs.company, cs.contact_reason, cs.message,\n  cs.created_at\nFROM contact_submissions cs\nWHERE cs.created_at > NOW() - INTERVAL '15 minutes'\n  AND cs.status = 'new'\nORDER BY cs.created_at DESC;"
      },
      "id": "get-new-contacts",
      "name": "PostgreSQL: Get New Contacts",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [850, 400]
    },
    {
      "parameters": {
        "content": "=ðŸ”” **Nouveaux visiteurs sur votre portfolio!**\n\nðŸ“Š **Statistiques (derniers 15 min):**\n- ðŸ‘¥ Visiteurs: {{ $json.total_visitors }}\n- ðŸ’¼ Mode CDI: {{ $json.cdi_mode }}\n- ðŸš€ Mode Freelance: {{ $json.freelance_mode }}\n- ðŸ“„ Pages vues (moy): {{ $json.avg_page_views }}\n- ðŸ”¥ Engagement Ã©levÃ©: {{ $json.high_engagement }}\n\nðŸ“¬ **Conversions:**\n- âœ‰ï¸ Contacts: {{ $json.contacts }}\n- ðŸ“¥ CV tÃ©lÃ©chargÃ©s: {{ $json.cv_downloads }}\n\nðŸŒ **Sources:**\n- Google: {{ $json.referrers.google }}\n- LinkedIn: {{ $json.referrers.linkedin }}\n- Direct: {{ $json.referrers.direct }}\n- Autres: {{ $json.referrers.other }}\n\n---\nVoir dÃ©tails: http://localhost:8000/api/analytics/summary",
        "options": {}
      },
      "id": "format-notification",
      "name": "Format: Notification Message",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [1050, 200]
    },
    {
      "parameters": {
        "content": "=ðŸ“¨ **NOUVEAU CONTACT!**\n\nðŸ‘¤ **De:** {{ $json.name }} ({{ $json.email }})\nðŸ¢ **Entreprise:** {{ $json.company || 'N/A' }}\nðŸŽ¯ **Motif:** {{ $json.contact_reason }}\n\nðŸ’¬ **Message:**\n{{ $json.message }}\n\n---\nðŸ• ReÃ§u: {{ $json.created_at }}\n\nAction: RÃ©pondre rapidement pour maximiser les chances de conversion!",
        "options": {}
      },
      "id": "format-contact-alert",
      "name": "Format: Contact Alert",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [1050, 400]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE contact_submissions SET status = 'notified' WHERE status = 'new' AND created_at > NOW() - INTERVAL '15 minutes';"
      },
      "id": "mark-contacts-notified",
      "name": "PostgreSQL: Mark as Notified",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [1250, 400]
    }
  ],
  "connections": {
    "Schedule: Every 15 min": {
      "main": [
        [
          {
            "node": "PostgreSQL: Get New Sessions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PostgreSQL: Get New Sessions": {
      "main": [
        [
          {
            "node": "IF: Has New Visitors?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF: Has New Visitors?": {
      "main": [
        [
          {
            "node": "Code: Aggregate Stats",
            "type": "main",
            "index": 0
          },
          {
            "node": "PostgreSQL: Get New Contacts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code: Aggregate Stats": {
      "main": [
        [
          {
            "node": "Format: Notification Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PostgreSQL: Get New Contacts": {
      "main": [
        [
          {
            "node": "Format: Contact Alert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format: Contact Alert": {
      "main": [
        [
          {
            "node": "PostgreSQL: Mark as Notified",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-10-01T12:00:00.000Z",
  "versionId": "1"
}

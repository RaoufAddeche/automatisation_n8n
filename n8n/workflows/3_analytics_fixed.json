{
  "name": "ðŸ“Š Analytics Daily Digest (Fixed)",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 9 * * *"
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Schedule Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [240, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  COUNT(DISTINCT session_id) as total_sessions,\n  COUNT(*) FILTER (WHERE event_type = 'page_view') as page_views,\n  COUNT(*) FILTER (WHERE event_type = 'project_click') as project_clicks,\n  COUNT(*) FILTER (WHERE event_type = 'contact_submit') as contacts,\n  COUNT(*) FILTER (WHERE event_type = 'cv_download') as cv_downloads\nFROM analytics_events\nWHERE created_at >= CURRENT_DATE - INTERVAL '1 day'\n  AND created_at < CURRENT_DATE;",
        "options": {}
      },
      "id": "get-yesterday-stats",
      "name": "PostgreSQL: Yesterday Stats",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [440, 300],
      "credentials": {
        "postgres": {
          "id": "1",
          "name": "Portfolio DB"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  p.title,\n  COUNT(*) as views,\n  p.category\nFROM analytics_events ae\nJOIN projects p ON ae.target_id = p.id\nWHERE ae.event_type = 'project_click'\n  AND ae.target_type = 'project'\n  AND ae.created_at >= CURRENT_DATE - INTERVAL '1 day'\nGROUP BY p.id, p.title, p.category\nORDER BY views DESC\nLIMIT 5;",
        "options": {}
      },
      "id": "get-top-projects",
      "name": "PostgreSQL: Top 5 Projects",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [640, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  DATE(created_at) as date,\n  COUNT(DISTINCT session_id) as sessions,\n  COUNT(*) FILTER (WHERE event_type = 'contact_submit') as contacts\nFROM analytics_events\nWHERE created_at >= CURRENT_DATE - INTERVAL '7 days'\nGROUP BY DATE(created_at)\nORDER BY date DESC\nLIMIT 7;",
        "options": {}
      },
      "id": "get-weekly-trend",
      "name": "PostgreSQL: 7 Days Trend",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [840, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  COUNT(*) as total_visitors,\n  COUNT(*) FILTER (WHERE landing_mode = 'cdi') as cdi_mode,\n  COUNT(*) FILTER (WHERE landing_mode = 'freelance') as freelance_mode,\n  COUNT(*) FILTER (WHERE contact_submitted = true) as contacts_submitted,\n  COUNT(*) FILTER (WHERE cv_downloaded = true) as cv_downloads,\n  AVG(page_views) as avg_page_views\nFROM visitor_sessions\nWHERE created_at >= CURRENT_DATE - INTERVAL '1 day'\n  AND created_at < CURRENT_DATE;",
        "options": {}
      },
      "id": "get-visitor-stats",
      "name": "PostgreSQL: Visitor Stats",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [1040, 300]
    },
    {
      "parameters": {
        "jsCode": "// Compile simple daily digest from all previous nodes\nconst allData = $input.all();\n\n// Get data from each node\nconst yesterdayStats = allData[0]?.json || {};\nconst topProjects = allData.slice(1, 6); // Projects are in items 1-5\nconst weeklyTrend = allData.slice(6); // Rest is weekly trend\nconst visitorStats = allData[allData.length - 1]?.json || {};\n\nconst today = new Date();\nconst yesterday = new Date(today);\nyesterday.setDate(yesterday.getDate() - 1);\n\nconst report = {\n  date: yesterday.toISOString().split('T')[0],\n  yesterday: {\n    sessions: yesterdayStats.total_sessions || 0,\n    page_views: yesterdayStats.page_views || 0,\n    project_clicks: yesterdayStats.project_clicks || 0,\n    contacts: yesterdayStats.contacts || 0,\n    cv_downloads: yesterdayStats.cv_downloads || 0,\n    engagement_rate: yesterdayStats.page_views > 0 ? \n      Math.round((yesterdayStats.project_clicks / yesterdayStats.page_views) * 100) : 0\n  },\n  visitors: {\n    total: visitorStats.total_visitors || 0,\n    cdi_mode: visitorStats.cdi_mode || 0,\n    freelance_mode: visitorStats.freelance_mode || 0,\n    avg_page_views: Math.round((visitorStats.avg_page_views || 0) * 10) / 10,\n    contacts: visitorStats.contacts_submitted || 0,\n    cv_downloads: visitorStats.cv_downloads || 0\n  },\n  top_projects: topProjects\n    .filter(p => p.json && p.json.title)\n    .map(p => ({\n      title: p.json.title,\n      views: p.json.views || 0,\n      category: p.json.category || 'N/A'\n    })),\n  weekly_summary: {\n    total_sessions: weeklyTrend.reduce((sum, d) => sum + (d.json?.sessions || 0), 0),\n    total_contacts: weeklyTrend.reduce((sum, d) => sum + (d.json?.contacts || 0), 0)\n  }\n};\n\nreturn [{ json: report }];"
      },
      "id": "compile-report",
      "name": "Code: Compile Report",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1240, 300]
    },
    {
      "parameters": {
        "content": "=ðŸ“Š **RAPPORT QUOTIDIEN - Portfolio Analytics**\nðŸ“… Date: {{ $json.date }}\n\n## ðŸ“ˆ Hier en Chiffres (Events)\n- ðŸ‘¥ Sessions: {{ $json.yesterday.sessions }}\n- ðŸ“„ Pages vues: {{ $json.yesterday.page_views }}\n- ðŸŽ¯ Clics projets: {{ $json.yesterday.project_clicks }}\n- ðŸ“Š Taux d'engagement: {{ $json.yesterday.engagement_rate }}%\n- âœ‰ï¸ Contacts: {{ $json.yesterday.contacts }}\n- ðŸ“¥ CV tÃ©lÃ©chargÃ©s: {{ $json.yesterday.cv_downloads }}\n\n## ðŸ‘¥ Visiteurs (Sessions)\n- Total visiteurs: {{ $json.visitors.total }}\n- Mode CDI: {{ $json.visitors.cdi_mode }}\n- Mode Freelance: {{ $json.visitors.freelance_mode }}\n- Pages vues (moy): {{ $json.visitors.avg_page_views }}\n- Contacts: {{ $json.visitors.contacts }}\n- CV tÃ©lÃ©chargÃ©s: {{ $json.visitors.cv_downloads }}\n\n## ðŸ” Top 5 Projets (24h)\n{{ $json.top_projects.length > 0 ? $json.top_projects.map((p, i) => `${i+1}. ${p.title} - ${p.views} vues (${p.category})`).join('\\n') : 'Aucun projet consultÃ© hier' }}\n\n## ðŸ“Š Tendance 7 jours\n- Total sessions: {{ $json.weekly_summary.total_sessions }}\n- Total contacts: {{ $json.weekly_summary.total_contacts }}\n- Conversion: {{ $json.weekly_summary.total_sessions > 0 ? Math.round(($json.weekly_summary.total_contacts / $json.weekly_summary.total_sessions) * 100) : 0 }}%\n\n---\nðŸ”— Dashboard: http://localhost:8000/api/analytics/summary\nðŸ“Š Projets: http://localhost:8000/api/projects",
        "options": {}
      },
      "id": "format-digest",
      "name": "Format: Daily Digest",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [1440, 300]
    }
  ],
  "connections": {
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "PostgreSQL: Yesterday Stats",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PostgreSQL: Yesterday Stats": {
      "main": [
        [
          {
            "node": "PostgreSQL: Top 5 Projects",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PostgreSQL: Top 5 Projects": {
      "main": [
        [
          {
            "node": "PostgreSQL: 7 Days Trend",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PostgreSQL: 7 Days Trend": {
      "main": [
        [
          {
            "node": "PostgreSQL: Visitor Stats",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PostgreSQL: Visitor Stats": {
      "main": [
        [
          {
            "node": "Code: Compile Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code: Compile Report": {
      "main": [
        [
          {
            "node": "Format: Daily Digest",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-10-02T16:30:00.000Z",
  "versionId": "3"
}
